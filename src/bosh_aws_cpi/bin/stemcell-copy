#!/bin/bash
#
# The user running this script requires password-less sudo privileges
# to copy the disk image to the raw disk device

set -euo pipefail

# make sure we have a secure PATH
PATH=/bin:/usr/bin
export PATH
if [[ $# -ne 2 ]]; then
  echo "usage: $0 <image-file> <block device>"
  exit 1
fi

IMAGE="$1"
OUTPUT_PATH="$2"

if [[ ! -b ${OUTPUT_PATH} ]]; then
  echo "ERROR: not a device: ${OUTPUT_PATH}"
  exit 1
fi

# copy image to block device with 1 MB block size
tar -xzf ${IMAGE} -O root.img | sudo -n dd bs=1M of=${OUTPUT_PATH}
